var pjson  = [
	{"x":-84.36488921793422, "y":33.757611419708809, "sec":1, "dir":20},
	{"x":-84.364838909406814, "y":33.757808413322678, "sec":3.5, "dir":300},
	{"x":-84.364781972880465, "y":33.757970183215193, "sec":4, "dir":20},
	{"x":-84.364759490264305, "y":33.758084616287725, "sec":10, "dir":300},
	{"x":-84.364730379649131, "y":33.758197981117661, "sec":12, "dir":20},
	{"x":-84.364690699289199, "y":33.758323434776464, "sec":13, "dir":20},
	{"x":-84.364637733719974, "y":33.758434590258112, "sec":17, "dir":20},
	{"x":-84.364582140320167, "y":33.75856555400118, "sec":20, "dir":20},
	{"x":-84.364521262048029, "y":33.758689890465227, "sec":22, "dir":300},
	{"x":-84.364428586907508, "y":33.758847264937614, "sec":24, "dir":25},
	{"x":-84.36436373767819, "y":33.75895730308725, "sec":25, "dir":25},
	{"x":-84.364297545322316, "y":33.759072875779339, "sec":26, "dir":25},
	{"x":-84.364163846695277, "y":33.759257752902926, "sec":29, "dir":300},
	{"x":-84.364083113637463, "y":33.759393133402654, "sec":31, "dir":25},
	{"x":-84.363940159180913, "y":33.759568105751953, "sec":33, "dir":30},
	{"x":-84.363798547850934, "y":33.759722152971868, "sec":35, "dir":30},
	{"x":-84.363650308521983, "y":33.759899357925462, "sec":39, "dir":30},
	{"x":-84.363475557197063, "y":33.760065541855639, "sec":43, "dir":30},
	{"x":-84.363303462914033, "y":33.76021854440387, "sec":45.2, "dir":45},
	{"x":-84.363144653840294, "y":33.760336251518773, "sec":47.4, "dir":45},
	{"x":-84.3629845600626, "y":33.760478208692888, "sec":49.6, "dir":45},
	{"x":-84.362813750483483, "y":33.7605926869659, "sec":51.8, "dir":45},
	{"x":-84.36257020818347, "y":33.760755543960279, "sec":54, "dir":45},
	{"x":-84.362392829028067, "y":33.760873298913197, "sec":56.2, "dir":45},
	{"x":-84.362244589699088, "y":33.760980057442843, "sec":58.4, "dir":45},
	{"x":-84.362121460816823, "y":33.761072518282951, "sec":60.6, "dir":45},
	{"x":-84.361954709828851, "y":33.761178159939938, "sec":62.8, "dir":45},
	{"x":-84.361836953452979, "y":33.76126724642414, "sec":65, "dir":45},
	{"x":-84.361712510655437, "y":33.761339850624033, "sec":68, "dir":45},
	{"x":-84.361602637771156, "y":33.761424567576256, "sec":71, "dir":45},
	{"x":-84.361470253059352, "y":33.761511493415455, "sec":72, "dir":300},
	{"x":-84.361328583306715, "y":33.761607230682188, "sec":73, "dir":45},
	{"x":-84.361184314934903, "y":33.761710662735155, "sec":77, "dir":45},
	{"x":-84.361057244306835, "y":33.761830649609067, "sec":79, "dir":45},
	{"x":-84.36092754584827, "y":33.761936241751236, "sec":81, "dir":35},
	{"x":-84.360754108438627, "y":33.762078196272363, "sec":82, "dir":35},
	{"x":-84.360624380768712, "y":33.762199202091793, "sec":84, "dir":30},
	{"x":-84.360522479009987, "y":33.762332369012391, "sec":85, "dir":30},
	{"x":-84.360395408381933, "y":33.762509568586822, "sec":87.2, "dir":25},
	{"x":-84.360259052713033, "y":33.762675747440355, "sec":90, "dir":25},
	{"x":-84.360163749741986, "y":33.762801170264673, "sec":92, "dir":300},
	{"x":-84.360084330599463, "y":33.762928801813253, "sec":93, "dir":25},
	{"x":-84.360012853371174, "y":33.763065268833472, "sec":96, "dir":15},
	{"x":-84.359959946224592, "y":33.763210522696589, "sec":98.2, "dir":15},
	{"x":-84.359897754037164, "y":33.763420684014129, "sec":100.4, "dir":15},
	{"x":-84.359820962725166, "y":33.763623174390645, "sec":102.6, "dir":305},
	{"x":-84.359769369493847, "y":33.763797021510534, "sec":103.8, "dir":15},
	{"x":-84.359709805136944, "y":33.763996209800275, "sec":107, "dir":70},
	{"x":-84.359679380606522, "y":33.764151317072319, "sec":108, "dir":15},
	{"x":-84.359643641992378, "y":33.764344994479615, "sec":112, "dir":5},
	{"x":-84.359627758163867, "y":33.764490246176742, "sec":113, "dir":0},
	{"x":-84.359607874166883, "y":33.764636589921011, "sec":114, "dir":0},
	{"x":-84.359595873964096, "y":33.764779110267995, "sec":118, "dir":0},
	{"x":-84.359597248301498, "y":33.764874288916111, "sec":120, "dir":260},
	{"x":-84.359642091788032, "y":33.76486272544448, "sec":121.5, "dir":260},
	{"x":-84.35968902771495, "y":33.764847781984351, "sec":123, "dir":260},
	{"x":-84.359761928197173, "y":33.764834498906502, "sec":124, "dir":240},
	{"x":-84.359825840948716, "y":33.764810423322622, "sec":128, "dir":240},
	{"x":-84.359905731888134, "y":33.76477638541666, "sec":132, "dir":240},
	{"x":-84.35999960374194, "y":33.764741517303847, "sec":136, "dir":240},
	{"x":-84.3600755001344, "y":33.764705818983167, "sec":139, "dir":240},
	{"x":-84.360176362445429, "y":33.764667630065524, "sec":141, "dir":160},
	{"x":-84.360173366535193, "y":33.76466181870699, "sec":144, "dir":60},
	{"x":-84.360021573750288, "y":33.764723253048615, "sec":146.8, "dir":60},
	{"x":-84.359925704622981, "y":33.764762272134604, "sec":150.5, "dir":60},
	{"x":-84.35983183276916, "y":33.764802951588337, "sec":158.2, "dir":60},
	{"x":-84.359776907748326, "y":33.764822046019134, "sec":161, "dir":80},
	{"x":-84.359750943193006, "y":33.764832008329165, "sec":163, "dir":80},
	{"x":-84.359686031804728, "y":33.764842800830401, "sec":165, "dir":80},
	{"x":-84.359641093151296, "y":33.764856083906963, "sec":166, "dir":80},
	{"x":-84.359598067818311, "y":33.764860779983223, "sec":167.8, "dir":350},
	{"x":-84.359615985109002, "y":33.765000228816966, "sec":169.6, "dir":350},
	{"x":-84.359625484897975, "y":33.765142097653353, "sec":171.4, "dir":350},
	{"x":-84.359640926668291, "y":33.765321156123797, "sec":173.2, "dir":350},
	{"x":-84.359655573713994, "y":33.765478158479375, "sec":175, "dir":350},
	{"x":-84.359686457254554, "y":33.765623644861329, "sec":176.8, "dir":350},
	{"x":-84.359728430033257, "y":33.765779010334519, "sec":178.6, "dir":330},
	{"x":-84.35979178656352, "y":33.765916598888168, "sec":180, "dir":330},
	{"x":-84.359844848580238, "y":33.766030149623049, "sec":182.8, "dir":330},
	{"x":-84.359919294348572, "y":33.766150936839956, "sec":186, "dir":270},
	{"x":-84.359988592860191, "y":33.766253632334362, "sec":186.5, "dir":330},
	{"x":-84.360105011407128, "y":33.766459368615472, "sec":191.2, "dir":330},
	{"x":-84.3602499293211, "y":33.766703929987067, "sec":194, "dir":330},
	{"x":-84.360424141326533, "y":33.766973188660302, "sec":196.8, "dir":315},
	{"x":-84.360591616626081, "y":33.767141357793228, "sec":199.6, "dir":315},
	{"x":-84.360831948244879, "y":33.767378995676459, "sec":203, "dir":315},
	{"x":-84.361085337460295, "y":33.767647906561677, "sec":208.2, "dir":315},
	{"x":-84.361476528974393, "y":33.768045528963491, "sec":211.4, "dir":315},
	{"x":-84.361743391601507, "y":33.76832003792434, "sec":215.6, "dir":315},
	{"x":-84.362016196209993, "y":33.768569848470648, "sec":218, "dir":260},
	{"x":-84.362299295332008, "y":33.768852913448313, "sec":218.5, "dir":315},
	{"x":-84.362469949529753, "y":33.769024727780554, "sec":225, "dir":315},
	{"x":-84.362664750562232, "y":33.76926632428183, "sec":232.4, "dir":320},
	{"x":-84.362839757292178, "y":33.769467428856146, "sec":237, "dir":320},
	{"x":-84.362994174995094, "y":33.769650096457191, "sec":239.8, "dir":260},
	{"x":-84.363129593120064, "y":33.769818291025935, "sec":241, "dir":320},
	{"x":-84.363247980025605, "y":33.769975285141435, "sec":245.4, "dir":320},
	{"x":-84.363377456169275, "y":33.770142818436312, "sec":247, "dir":320},
	{"x":-84.363476048772327, "y":33.770282036224934, "sec":252, "dir":335},
	{"x":-84.363564725771326, "y":33.770451550817725, "sec":253.8, "dir":335},
	{"x":-84.363624108678849, "y":33.77058287121843, "sec":256.6, "dir":335},
	{"x":-84.363718348749671, "y":33.770759621456598, "sec":259.4, "dir":335},
	{"x":-84.363772584400451, "y":33.770898838242076, "sec":262, "dir":335},
	{"x":-84.363862850848534, "y":33.770969280007968, "sec":265.3, "dir":345},
	{"x":-84.363981237754089, "y":33.771243118975896, "sec":268, "dir":345},
	{"x":-84.364044631189984, "y":33.771380698756026, "sec":271.9, "dir":345},
	{"x":-84.36412184004142, "y":33.771612755615685, "sec":275.2, "dir":345},
	{"x":-84.364227132444739, "y":33.771922773252768, "sec":278.5, "dir":345},
	{"x":-84.364264336876118, "y":33.772111696161637, "sec":281.8, "dir":345},
	{"x":-84.364341545727584, "y":33.772398367487298, "sec":285.1, "dir":345},
	{"x":-84.364436580522948, "y":33.772740660351097, "sec":288.4, "dir":350},
	{"x":-84.364514584098984, "y":33.773018111684074, "sec":291.7, "dir":350},
	{"x":-84.364578319538708, "y":33.773326833704132, "sec":295, "dir":345},
	{"x":-84.364629792106342, "y":33.773545043198041, "sec":298.2, "dir":345},
	{"x":-84.364670970160446, "y":33.773686237280295, "sec":299, "dir":280},
	{"x":-84.364717295471323, "y":33.773904445858804, "sec":299.5, "dir":50},
	{"x":-84.364795714862396, "y":33.774171039490405, "sec":301, "dir":345},
	{"x":-84.36488124986883, "y":33.774530124561281, "sec":306, "dir":45},
	{"x":-84.364921633198378, "y":33.77476708135503, "sec":307, "dir":280},
	{"x":-84.364988547536299, "y":33.775019515495067, "sec":308, "dir":345},
	{"x":-84.365060609131007, "y":33.775286420616126, "sec":315.6, "dir":345},
	{"x":-84.365110492249542, "y":33.775533253526881, "sec":323.8, "dir":345},
	{"x":-84.365184143293334, "y":33.775787006591479, "sec":327, "dir":345},
	{"x":-84.365229673879639, "y":33.775978532666379, "sec":330.2, "dir":345},
	{"x":-84.365308472180203, "y":33.776263900548756, "sec":333.4, "dir":345},
	{"x":-84.365376181242695, "y":33.776564714536633, "sec":336, "dir":345},
	{"x":-84.365463684607661, "y":33.776839511152588, "sec":338.9, "dir":345},
	{"x":-84.365529009496512, "y":33.777074825444195, "sec":341.8, "dir":345},
	{"x":-84.365601071091177, "y":33.777299285553639, "sec":344.7, "dir":345},
	{"x":-84.365672337961328, "y":33.777532616850365, "sec":347.6, "dir":345},
	{"x":-84.365730131419753, "y":33.777802817015719, "sec":350.5, "dir":345},
	{"x":-84.365808929720302, "y":33.777993363053298, "sec":353.4, "dir":345},
	{"x":-84.36588258076408, "y":33.778177333621215, "sec":356.3, "dir":345},
	{"x":-84.3659392005885, "y":33.778349129249307, "sec":359, "dir":280},
	{"x":-84.366021556696722, "y":33.77852322119081, "sec":360.5, "dir":340},
	{"x":-84.366147059217624, "y":33.778787158179149, "sec":365, "dir":340},
	{"x":-84.366240504563905, "y":33.778982325986142, "sec":367.9, "dir":340},
	{"x":-84.366361654552577, "y":33.779201181639451, "sec":370, "dir":280},
	{"x":-84.366467362770976, "y":33.779389427934255, "sec":371, "dir":340},
	{"x":-84.366590896933317, "y":33.779577673815368, "sec":375.3, "dir":330},
	{"x":-84.366738199020901, "y":33.779765919282738, "sec":377.6, "dir":330},
	{"x":-84.366892616723803, "y":33.779988390665352, "sec":379.9, "dir":330},
	{"x":-84.367049002785279, "y":33.78021086147011, "sec":382.2, "dir":330},
	{"x":-84.367198273231423, "y":33.780407662084954, "sec":384.5, "dir":330},
	{"x":-84.367321807393765, "y":33.780570236164856, "sec":386.8, "dir":330},
	{"x":-84.367435047042562, "y":33.780711418668083, "sec":389.1, "dir":280},
	{"x":-84.367557786480333, "y":33.780827592003625, "sec":390, "dir":330},
	{"x":-84.367672199763163, "y":33.780984251010352, "sec":393.7, "dir":330},
	{"x":-84.367745056082398, "y":33.781085953224355, "sec":395, "dir":330},
	{"x":-84.367969945930909, "y":33.781378508774608, "sec":401, "dir":330},
	{"x":-84.368110095497528, "y":33.781559829892089, "sec":403, "dir":330},
	{"x":-84.368269281547754, "y":33.781771128714631, "sec":407, "dir":330},
	{"x":-84.368392020985524, "y":33.781860940213832, "sec":410, "dir":290},
	{"x":-84.368531412733233, "y":33.781900765063298, "sec":413, "dir":290}
];

L.mapbox.accessToken = 'pk.eyJ1IjoibW90aGVoZXJkZXIiLCJhIjoiWV9xTVZCcyJ9.NT5sIG2mvLVG2HCmLbsaug';
var map = L.mapbox.map('map', 'motheherder.jf8ah589').setView([33.7695, -84.351], 15);

var video = $('#video');

// build line vector based on json points
var point_locs = [];
for (var i = 0, e = pjson.length; i < e; ++i) {
	point_locs[i] = [pjson[i].x, pjson[i].y];
}
var line_geojson = {
	type: "Feature",
	geometry: {type: "LineString", coordinates: point_locs},
	properties: {"stroke": "#fc4353", "stroke-width": 5}
};
L.geoJson(line_geojson, { style: L.mapbox.simplestyle.style }).addTo(map);

// Rotating and controllable marker code by Benjamin Becquet
// https://github.com/bbecquet/Leaflet.PolylineDecorator
L.RotatedMarker = L.Marker.extend({
  options: { angle: 0 },
  _setPos: function(pos) {
	L.Marker.prototype._setPos.call(this, pos);
	if (L.DomUtil.TRANSFORM) {
	  // use the CSS transform rule if available
	  this._icon.style[L.DomUtil.TRANSFORM] += ' rotate(' + this.options.angle + 'deg)';
	} else if (L.Browser.ie) {
	  // fallback for IE6, IE7, IE8
	  var rad = this.options.angle * L.LatLng.DEG_TO_RAD,
	  costheta = Math.cos(rad),
	  sintheta = Math.sin(rad);
	  this._icon.style.filter += ' progid:DXImageTransform.Microsoft.Matrix(sizingMethod=\'auto expand\', M11=' +
		costheta + ', M12=' + (-sintheta) + ', M21=' + sintheta + ', M22=' + costheta + ')';
	}
  }
});

L.rotatedMarker = function(pos, options) {
	return new L.RotatedMarker(pos, options);
};

// mapbox draggable marker example
// https://www.mapbox.com/mapbox.js/example/v1.0.0/draggable-marker/
var marker = L.rotatedMarker(new L.LatLng(pjson[0].y, pjson[0].x), {
	icon: L.icon({
	iconUrl: 'north.png',
	iconSize: [37, 37],
	}),
	draggable: true
}).addTo(map);

marker.on('dragend', function(event) {
	var marker = event.target;
	var result = marker.getLatLng();
	video.get(0).currentTime = nearest_point(result.lat, result.lng).sec;
});

function set_marker(point) {
	marker.setLatLng(L.latLng(point.y, point.x));
	set_marker.now = point;
	marker.options.angle = point.dir;
}
set_marker.now = pjson[0];

// handle for marker location based on video time
function point_at_time(timeindex_sec) {
	var time_index = pjson[0];
	var min_time = Number.POSITIVE_INFINITY;
	for (var i = 0, e = pjson.length; i < e; ++i) {
		var this_time = Math.abs(pjson[i].sec - timeindex_sec);
		if (this_time < min_time) {
			time_index = pjson[i];
			min_time = this_time;
		}
	}
	return time_index;
}

// listeners on the video used to place marker
video.on('seeked', function () {
	set_marker(point_at_time(this.currentTime));
});

video.on('timeupdate', function() {
	var time_index = point_at_time(this.currentTime);
	if (time_index !== set_marker.now) {
		set_marker(time_index);
	}
});

video.on('ended', function() {
	set_marker(pjson[pjson.length-1]);
});

function lineDistance(x1, y1, x2, y2) {
	var xs = 0, ys = 0;
	xs = x2 - x1;
	xs = xs * xs;
	ys = y2 - y1;
	ys = ys * ys;
	return Math.sqrt(xs + ys);
}

function nearest_point(lat, lng) {
	var dist = Number.POSITIVE_INFINITY;
	var time_index;
	for (var i = 0, e = pjson.length; i < e; ++i) {
		var this_distance = lineDistance(lng.toString(), lat.toString(), pjson[i].x, pjson[i].y);
		if (this_distance < dist) {
			dist = this_distance
			time_index = pjson[i];
		}
	}
	return time_index;
}

// map listener to update timeindex associated with nearest point
map.on('click', function (e) {
	video.get(0).currentTime = nearest_point(e.latlng.lat, e.latlng.lng).sec;
});
